services:

  app_proxy:
    environment:
      # The format here is: <app-id>_<docker-service-name>_1
      APP_HOST: cloudrack-wordpress_1
      APP_PORT: 8088
    
  server:
    image: github.com/cloudrack-ca/umbrel-template:latest
    user: "1000:1000"
    init: true

  app_proxy:
    container_name: app_proxy
    image: traefik:v2.5
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.mytlschallenge.acme.tlschallenge=true"
      - "--certificatesresolvers.mytlschallenge.acme.email=acme@infinitehost.ca"
      - "--certificatesresolvers.mytlschallenge.acme.storage=/letsencrypt/acme.json"
    ports:
      - target: 80
        published: "8088"
        protocol: tcp
      - target: 443
        published: "443"
        protocol: tcp
    volumes:
      - type: bind
        source: /var/run/docker.sock
        target: /var/run/docker.sock
      - type: bind
        source: /DATA/Letsencrypt
        target: /letsencrypt
    networks:
      - proxy
  db:
    container_name: db
    image: mysql:latest
    environment:
      - MYSQL_DATABASE=database
      - MYSQL_PASSWORD=password
      - MYSQL_ROOT_PASSWORD=rootpass
      - MYSQL_USER=username
    ports:
      - target: 3306
        published: "3306"
        protocol: tcp
    privileged: true
    restart: always
    volumes:
      - type: bind
        source: /DATA/AppData/wordpress/db/data
        target: /var/lib/mysql
    networks:
      - db
      - proxy
  wordpress:
    container_name: wordpress
    depends_on:
      db:
        condition: service_started
        required: true
    environment:
      - WORDPRESS_DB_HOST=db:3306
      - WORDPRESS_DB_NAME=database
      - WORDPRESS_DB_PASSWORD=password
      - WORDPRESS_DB_USER=username
    image: wordpress:latest
    labels:
      io.umbrel.app: wordpress
      io.umbrel.app.name: Wordpress
      io.umbrel.app.version: 1.0.0
      io.umbrel.app.description: "WordPress (also known as WP or WordPress.org) is a web content management system. It was originally created as a tool to publish blogs but has evolved to support publishing other web content, including more traditional websites, mailing lists and Internet forum, media galleries, membership sites, learning management systems and online stores. Available as free and open-source software, WordPress is among the most popular content management systems â€“ it was used by 42.8% of the top 10 million websites as of October 2021."
      io.umbrel.app.ports: "8880"
      io.umbrel.app.dependencies: '["db"]'
      io.umbrel.app.dockerArgs: '["--network=proxy"]'
    ports:
      - target: 80
        published: "8880"
        protocol: tcp
    privileged: true
    restart: always
    volumes:
      - type: bind
        source: /DATA/AppData/wordpress/wp-content
        target: /var/www/html/wp-content
    networks:
      - db
      - proxy

networks:
  db:
    name: db
  proxy:
    name: proxy
